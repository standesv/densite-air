<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RideScore</title>
<link rel="preconnect" href="https://api.open-meteo.com"/>
<link rel="preconnect" href="https://geocoding-api.open-meteo.com"/>
<style>
  :root{ /* Th√®me sombre par d√©faut */
    --bg:#0b1120; --panel:#101826; --muted:#9fb0c7; --brand:#13b0a6; --brand-ink:#062a2b;
    --ok:#10b981; --warn:#f6b234; --err:#ef4444; --text:#e5e7eb; --stroke:#0f172a;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --brand:#12a39a; --brand-ink:#042425; --ok:#0f9f76; --warn:#e79f2d; --err:#dc2626; --text:#0b1120; --stroke:#1f2937; }
  }
  :root[data-theme="light"]{ --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --brand:#12a39a; --brand-ink:#042425; --ok:#0f9f76; --warn:#e79f2d; --err:#dc2626; --text:#0b1120; --stroke:#1f2937; }
  :root[data-theme="dark"]{ --bg:#0b1120; --panel:#101826; --muted:#9fb0c7; --brand:#13b0a6; --brand-ink:#062a2b; --ok:#10b981; --warn:#f6b234; --err:#ef4444; --text:#e5e7eb; --stroke:#0f172a; }

  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{padding:12px 16px;text-align:center}
  .container{max-width:980px;margin:0 auto;padding:0 10px 80px}
  .card{background:var(--panel);border:1px solid #ffffff14;border-radius:14px;padding:10px;margin-top:10px}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px}
  input{width:100%;padding:14px;border-radius:12px;border:1px solid #ffffff22;background:transparent;color:var(--text);font-size:16px}
  input[type=number]{-moz-appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
  button{border:0;border-radius:12px;padding:14px 16px;font-weight:700;cursor:pointer;background:var(--brand);color:var(--brand-ink);font-size:16px;transition:transform .05s ease,filter .15s ease}
  button:active{transform:translateY(1px)}
  button.secondary{background:#1f2937;color:#e5e7eb}
  .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1 1 160px}
  .grid{display:grid;gap:10px}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}
  @media(max-width:900px){.two,.three{grid-template-columns:1fr}}
  .kpi{display:grid;grid-template-columns:1fr auto;gap:4px;padding:10px;border-radius:12px;background:transparent;border:1px solid #ffffff10}
  .kpi .label{color:var(--muted);font-size:12px}.kpi .value{font-size:18px;font-weight:800}
  .results{display:grid;gap:8px;margin-top:6px}
  .cityItem{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:#0b1220;border:1px solid #ffffff26;color:#fff;cursor:pointer;min-height:48px}
  :root[data-theme="light"] .cityItem{background:#f1f5f9;color:#0b1120;border-color:#cbd5e1}
  .gaugeSVG{max-width:220px;height:auto;display:block;margin:auto}
  .guidance{text-align:center;color:#cbd5e1;font-size:13px;margin-top:8px}
  :root[data-theme="light"] .guidance{color:#475569}
  .lamps{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:6px;margin-top:8px}
  .lamp{display:flex;gap:10px;align-items:center;background:#0b1220;border:1px solid #ffffff14;border-radius:12px;padding:10px;min-height:48px}
  :root[data-theme="light"] .lamp{background:#f1f5f9;border-color:#cbd5e1}
  .led{width:11px;height:11px;border-radius:50%;background:#334155}
  .on.green{background:var(--ok)}.on.yellow{background:var(--warn)}.on.red{background:var(--err)}
  .muted{color:var(--muted)}
  .sectionTitle{margin:0 0 8px;font-size:18px}
  .tabs{position:sticky;top:0;z-index:5;background:linear-gradient(var(--bg),rgba(0,0,0,0))}
  .tabs button{flex:1}
  .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:10;display:flex;gap:8px;padding:10px;border-top:1px solid #ffffff14;background:var(--bg)}
  .stickyBar button{flex:1}
  details{background:transparent;border:1px solid #ffffff14;border-radius:12px;padding:8px}
  summary{cursor:pointer;font-weight:700;color:var(--muted);margin:4px 0}
  @media(max-width:480px){
    .gaugeSVG{max-width:180px}
    header h1{font-size:18px}
    button,input{font-size:16px}
  }
  /* Anim logo: l√©g√®re rotation de l‚Äôaiguille au chargement */
  @keyframes sweep { 0%{ transform:rotate(-18deg);} 60%{ transform:rotate(6deg);} 100%{ transform:rotate(0deg);} }
  .logo-needle{ animation:sweep .9s ease-out both; }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:0 6px">
    <div style="display:flex;align-items:center;gap:10px;justify-content:center;margin:auto">
      <!-- Logo inline -->
      <svg width="44" height="44" viewBox="0 0 96 96" aria-label="RideScore" role="img">
        <defs>
          <linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="var(--ok)"/>
            <stop offset="50%" stop-color="var(--warn)"/>
            <stop offset="100%" stop-color="var(--err)"/>
          </linearGradient>
        </defs>
        <path d="M26 62c-6 0-11-5-11-11s5-11 11-11c2-8 9-14 18-14 10 0 18 8 18 18 6 0 11 5 11 11s-5 11-11 11H26z" fill="#2b3448" stroke="var(--stroke)" stroke-width="3" opacity=".35"/>
        <path d="M18 55c0-14 12-26 26-26 11 0 21 7 24 17l1 3c1 3-1 7-4 8l-10 5c-3 2-7 3-11 3H32c-8 0-14-6-14-10z" fill="#fff" stroke="var(--stroke)" stroke-width="3"/>
        <circle cx="47" cy="43" r="4" fill="var(--stroke)"/>
        <path d="M34 45h18c3 0 5 2 5 5v3H32v-3c0-3 1-5 2-5z" fill="#c8d8e8" stroke="var(--stroke)" stroke-width="3"/>
        <path d="M70 26a26 26 0 1 1-2 27" fill="none" stroke="var(--stroke)" stroke-width="5" opacity=".5"/>
        <path d="M70 26a26 26 0 0 1 20 13" fill="none" stroke="url(#gaugeGrad)" stroke-width="7"/>
        <g class="logo-needle" style="transform-origin:70px 52px; transform-box:fill-box">
          <circle cx="70" cy="52" r="3.5" fill="var(--stroke)"/>
          <line x1="70" y1="52" x2="84" y2="45" stroke="var(--stroke)" stroke-width="4" stroke-linecap="round"/>
        </g>
      </svg>
      <div>
        <h1 style="margin:0 0 2px">RideScore</h1>
        <p class="muted" style="margin:0">Densit√© de l‚Äôair, score m√©t√©o et voyants ‚Äî Open‚ÄëMeteo</p>
      </div>
    </div>
    <button id="btnTheme" title="Basculer clair/sombre" style="min-width:44px" class="secondary">üåô</button>
  </div>
</header>

<main class="container">
  <!-- SECTION ‚Äî Ville ou Itin√©raire (m√™me jauges) -->
  <section class="card">
    <h2 class="sectionTitle">Ville / Itin√©raire √† une date</h2>

    <!-- Onglets -->
    <div class="row tabs" role="tablist" aria-label="Mode de recherche">
      <button id="tabSingle" aria-selected="true" role="tab">Ville (jour)</button>
      <button id="tabRoute" aria-selected="false" role="tab" class="secondary">Itin√©raire (jour)</button>
    </div>

    <!-- Panel VILLE -->
    <div id="panelSingle" role="tabpanel" aria-labelledby="tabSingle" style="margin-top:8px">
      <div class="grid three">
        <div>
          <label for="city">Ville</label>
          <input id="city" type="text" placeholder="Ex. Paris, Lyon, Marseille‚Ä¶" autocomplete="off"/>
          <div id="results" class="results" aria-live="polite"></div>
        </div>
        <div>
          <label for="date">Date</label>
          <input id="date" type="date"/>
          <p class="muted" style="margin:.25rem 0 0;font-size:11px">S√©lectionnez la date dans le calendrier</p>
        </div>
      </div>
      <details style="margin-top:8px">
        <summary>Options avanc√©es</summary>
        <div class="row" style="margin-top:6px">
          <div>
            <label for="lat">Latitude</label>
            <input id="lat" type="number" step="0.0001" inputmode="decimal" placeholder="48.8566"/>
          </div>
          <div>
            <label for="lon">Longitude</label>
            <input id="lon" type="number" step="0.0001" inputmode="decimal" placeholder="2.3522"/>
          </div>
        </div>
      </details>
      <p id="status" class="muted" style="margin:6px 0 0"></p>
    </div>

    <!-- Panel ITINERAIRE -->
    <div id="panelRoute" role="tabpanel" aria-labelledby="tabRoute" style="display:none;margin-top:8px">
      <div class="grid three">
        <div>
          <label for="cityA">Ville d√©part</label>
          <input id="cityA" type="text" placeholder="Ex. Lille" autocomplete="off"/>
          <div id="resultsA" class="results" aria-live="polite"></div>
        </div>
        <div>
          <label for="cityB">Ville arriv√©e</label>
          <input id="cityB" type="text" placeholder="Ex. Bordeaux" autocomplete="off"/>
          <div id="resultsB" class="results" aria-live="polite"></div>
        </div>
        <div>
          <label for="dateRoute">Date</label>
          <input id="dateRoute" type="date"/>
          <p class="muted" style="margin:.25rem 0 0;font-size:11px">Choisissez la date du trajet</p>
        </div>
      </div>
      <p id="statusRoute" class="muted" style="margin:6px 0 0"></p>
    </div>
  </section>

  <!-- KPIs & Jauges (communs) -->
  <section class="card">
    <div class="grid two">
      <div class="kpi"><div class="label">Temp√©rature moy. jour (¬∞C)</div><div class="value" id="kT">‚Äî</div></div>
      <div class="kpi"><div class="label">RH moy. (%)</div><div class="value" id="kRH">‚Äî</div></div>
      <div class="kpi"><div class="label">Pression moy. (hPa)</div><div class="value" id="kP">‚Äî</div></div>
      <div class="kpi"><div class="label">Vent/Rafales max (km/h)</div><div class="value" id="kWind">‚Äî</div></div>
      <div class="kpi"><div class="label">Pr√©cip. max (mm/h)</div><div class="value" id="kPrec">‚Äî</div></div>
      <div class="kpi"><div class="label">œÅ moy. (kg¬∑m‚Åª¬≥)</div><div class="value" id="kRho">‚Äî</div></div>
      <div class="kpi"><div class="label">œÅ/œÅ‚ÇÄ moy.</div><div class="value" id="kRatio">‚Äî</div></div>
      <div class="kpi"><div class="label">Jour √©valu√©</div><div class="value" id="kTs" style="font-size:12px">‚Äî</div></div>
    </div>
  </section>

  <section class="card">
    <div class="grid two">
      <div>
        <p class="muted" style="margin:0 0 4px">Jauge densit√© (air pauvre ‚Üí riche)</p>
        <div id="gRho"></div>
        <div id="gRhoTxt" class="guidance">‚Äî</div>
      </div>
      <div>
        <p class="muted" style="margin:0 0 4px">Score m√©t√©o moto du jour (0 ‚Üí 100)</p>
        <div id="gScore"></div>
        <div id="gScoreTxt" class="guidance">‚Äî</div>
      </div>
    </div>
    <div id="lamps" class="lamps"></div>
  </section>

  <section class="card">
    <h2 class="sectionTitle">R√©sum√© des ph√©nom√®nes du jour</h2>
    <p id="dayMsg" class="guidance">‚Äî</p>
  </section>
</main>

<div class="stickyBar" aria-live="polite">
  <button id="btnGeo">üìç Ma position</button>
  <button id="btnPrimary">üîÑ √âvaluer</button>
</div>

<script>
(function(){
  'use strict';
  // ===== Helpers
  const $=(id)=>document.getElementById(id);
  const fmt=(v,u="")=>(v==null||Number.isNaN(+v))?"‚Äî":`${(+v).toFixed(2)}${u}`;
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const polar=(cx,cy,r,aDeg)=>{const a=aDeg*Math.PI/180;return{x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)}};
  const todayISO=()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10)};

  // ===== Theme toggle persist
  const themeBtn=$("btnTheme");
  const root=document.documentElement;
  const saved=localStorage.getItem('ridescore-theme'); if(saved){ root.setAttribute('data-theme', saved); if(themeBtn) themeBtn.textContent = saved==='light'?'üåô':'‚òÄÔ∏è'; }
  if(themeBtn) themeBtn.addEventListener('click',()=>{
    const current=root.getAttribute('data-theme');
    const next = current==='light' ? 'dark' : (current==='dark' ? '' : 'light');
    if(next){ root.setAttribute('data-theme', next); } else { root.removeAttribute('data-theme'); }
    localStorage.setItem('ridescore-theme', next||'');
    themeBtn.textContent = (next==='light') ? 'üåô' : '‚òÄÔ∏è';
  }, {passive:true});

  // ===== Physique ‚Äî densit√© air humide
  function rhoFromTRP(T_C,RH,p_hPa){
    if([T_C,RH,p_hPa].some(v=>v==null||isNaN(v))) return null;
    const T_K=T_C+273.15; const es=6.112*Math.exp(17.62*T_C/(243.12+T_C));
    const e=(RH/100)*es, pd=p_hPa-e; const R=8.314462618, Md=0.0289652, Mv=0.018016;
    return ((pd*100)*Md + (e*100)*Mv)/(R*T_K);
  }

  // ===== Scoring m√©t√©o (par heure) puis agr√©g√© jour (pire heure)
  const scoreFromTemperature=T=> (T==null||isNaN(T))?12: (T>=10&&T<=25?25:((T>=5&&T<10)||(T>25&&T<=30)?15:5));
  const scoreFromRain=p=> (p==null||isNaN(p))?12:(p===0?15:(p<1?8:0));
  const scoreFromWind=(w,g)=>{const v=Math.max(w||0,g||0);return v<25?20:(v<50?10:0)};
  const scoreFromRoadRisk=(T,RH,p)=> (T!=null&&T<=0&&(p>0||(RH!=null&&RH>80)))?0:((p>0&&p<1)||(RH!=null&&RH>90)?5:10);
  const scoreFromBlackIce=(T,RH,p)=> (T==null||isNaN(T))?6: (T<=0&&(p>0||(RH!=null&&RH>=85))?0:(T<=2&&(p>0||(RH!=null&&RH>=90))?4:10));
  const scoreFromFog=(vis,RH)=> (vis==null||isNaN(vis))?((RH!=null&&RH>95)?2:5):(vis<200?0:(vis<1000?2:(vis<4000?4:5)));
  const scoreFromDensity=r=> (r==null||isNaN(r))?10: (r>=0.95&&r<=1.05?15:((r>=0.93&&r<0.95)||(r>1.05&&r<=1.07)?8:3));
  function scoreHour({T,RH,P,W,G,R,V}){
    const rho=rhoFromTRP(T,RH,P); const ratio=rho?rho/1.225:null;
    return Math.round(Math.min(100,Math.max(0,
      scoreFromTemperature(T)+scoreFromRain(R)+scoreFromWind(W,G)+scoreFromRoadRisk(T,RH,R)+scoreFromDensity(ratio)+scoreFromBlackIce(T,RH,R)+scoreFromFog(V,RH)
    )));
  }

  // ===== Couleurs / Jauges
  function gaugeHalfGradient(elId, value, vMin, vMax, stops){
    const el=$(elId); if(!el) return; if(value==null||isNaN(value)){el.innerHTML='<div class="guidance">‚Äî</div>';return}
    const t=(clamp(value,vMin,vMax)-vMin)/(vMax-vMin);
    const size=220,cx=size/2,cy=size/2,R=96,ang=-90+180*t,arc=Math.PI*R;
    const s=polar(cx,cy,R,-90),e=polar(cx,cy,R,90),tip=polar(cx,cy,R-12,ang);
    const gid=`g_${elId}`; const stopsSvg=stops.map(([off,col])=>`<stop offset="${off}%" stop-color="${col}"/>`).join('');
    el.innerHTML=`<svg class="gaugeSVG" viewBox="0 0 ${size} ${size}">
      <defs><linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="0%">${stopsSvg}</linearGradient></defs>
      <path d="M ${s.x} ${s.y} A ${R} ${R} 0 0 1 ${e.x} ${e.y}" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="12"/>
      <path d="M ${s.x} ${s.y} A ${R} ${R} 0 0 1 ${e.x} ${e.y}" fill="none" stroke="url(#${gid})" stroke-width="12" stroke-dasharray="${Math.max(1,arc)}" stroke-dashoffset="${(1-t)*arc}"/>
      <line x1="${cx}" y1="${cy}" x2="${tip.x}" y2="${tip.y}" stroke="var(--text)" stroke-width="4" stroke-linecap="round"/>
      <circle cx="${cx}" cy="${cy}" r="5" fill="var(--text)"/>
    </svg>`;
  }

  // ===== Agr√©gations jour & voyants
  function computeDaySummaryFromHourly(H, dateISO){
    const times=H.time||[]; const idx=[]; for(let i=0;i<times.length;i++){ if(String(times[i]).startsWith(dateISO)) idx.push(i); }
    if(idx.length===0) return null;
    let maxWind=0, maxGust=0, maxPrec=0, minTemp=Infinity, minVis=Infinity, maxRH=0;
    let rhoSum=0, rhoCount=0; let worstScore=100;
    for(const i of idx){
      const T=H.temperature_2m?.[i]; const RH=H.relative_humidity_2m?.[i]; const P=H.surface_pressure?.[i];
      const W=H.wind_speed_10m?.[i]; const G=H.wind_gusts_10m?.[i]; const R=H.precipitation?.[i]; const V=H.visibility?.[i];
      const r=rhoFromTRP(T,RH,P); if(r!=null){rhoSum+=r; rhoCount++;}
      const s=scoreHour({T,RH,P,W,G,R,V}); worstScore=Math.min(worstScore,s);
      maxWind=Math.max(maxWind, W||0); maxGust=Math.max(maxGust, G||0); maxPrec=Math.max(maxPrec, R||0);
      if(T!=null) minTemp=Math.min(minTemp,T); if(V!=null) minVis=Math.min(minVis,V); if(RH!=null) maxRH=Math.max(maxRH,RH);
    }
    const rhoMean = rhoCount? (rhoSum/rhoCount) : null; const ratioMean = rhoMean? rhoMean/1.225 : null;
    const events=[]; if(maxPrec>0) events.push('averses'); if(maxWind>=25 || maxGust>=50) events.push('vent'); if(minTemp<=0) events.push('risque de verglas'); if((minVis<1000)||maxRH>95) events.push('brouillard'); if(maxPrec>=1) events.push('pantalon/chaussures √©tanches');
    const Tmean = avgOnIdx(H.temperature_2m, idx); const RHmean = avgOnIdx(H.relative_humidity_2m, idx); const Pmean = avgOnIdx(H.surface_pressure, idx);
    const Wmax=maxWind, Gmax=maxGust, Rmax=maxPrec, Vmin=(minVis<Infinity?minVis:null);
    return {rhoMean, ratioMean, scoreDay:worstScore, events, Tmean,RHmean,Pmean,Wmax,Gmax,Rmax,Vmin};
  }
  function avgOnIdx(arr, idxs){ if(!arr) return null; let s=0,c=0; for(const i of idxs){ const v=arr[i]; if(v!=null){s+=v;c++;}} return c? s/c : null; }
  function avg2(a,b){ if(a==null||isNaN(a)) return b; if(b==null||isNaN(b)) return a; return (a+b)/2; }

  function renderLamps({Tmean,RHmean,Rmax,Wmax,Gmax,Vmin}){
    const cont=$("lamps"); if(!cont) return;
    const T=Tmean, RH=RHmean, precip_mmph=Rmax, wind_kmh=Wmax, gust_kmh=Gmax, visibility_m=Vmin;
    const v=Math.max(wind_kmh||0,gust_kmh||0);
    const verglas=(T!=null&&T<=1)&&((precip_mmph!=null&&precip_mmph>0)||(RH!=null&&RH>=90));
    const fogDense=(visibility_m!=null&&visibility_m<200)||(RH!=null&&RH>98);
    const fog=fogDense||(visibility_m!=null&&visibility_m<1000)||(RH!=null&&RH>95);
    const gantsHiverOn = (T!=null && T<10); const gantsEteOn=!gantsHiverOn; // toujours un actif
    const vesteChaudeOn= (T!=null && T<15); const vesteLegereOn=!vesteChaudeOn; // toujours une active
    const lamps=[
      {label:'Gants hiver', icon:'üß§', on:gantsHiverOn, tone:(T<5?'red':(T<10?'yellow':'green'))},
      {label:'Gants √©t√©', icon:'üß§', on:gantsEteOn,   tone:(T>30?'red':(T>25?'yellow':'green'))},
      {label:'Veste chaude', icon:'üß•', on:vesteChaudeOn, tone:(T<8?'red':(T<15?'yellow':'green'))},
      {label:'Veste l√©g√®re', icon:'üß•', on:vesteLegereOn, tone:(T>28?'red':(T>20?'yellow':'green'))},
      {label:'Pantalon pluie', icon:'üëñ', on:((precip_mmph!=null&&precip_mmph>0)||(RH!=null&&RH>80)), tone:(precip_mmph>=1?'red':'yellow')},
      {label:'Chaussures √©tanches', icon:'üë¢', on:(precip_mmph!=null&&precip_mmph>=1), tone:(precip_mmph>=2?'red':'yellow')},
      {label:'Attention vent', icon:'üí®', on:(v>=25), tone:(v>50?'red':'yellow')},
      {label:'Risque verglas', icon:'üßä', on:verglas, tone:(T!=null&&T<=0)?'red':'yellow'},
      {label:'Brouillard', icon:'üå´Ô∏è', on:fog, tone:(fogDense?'red':'yellow')},
      {label:'Visi√®re claire', icon:'üï∂Ô∏è', on:((RH!=null&&RH>95)||(precip_mmph!=null&&precip_mmph>0)), tone:'yellow'}
    ];
    cont.innerHTML=lamps.map(l=>`<div class="lamp"><span class="led ${l.on?('on '+l.tone):''}"></span><span>${l.icon} ${l.label}</span></div>`).join('');
  }

  // ===== API ‚Äî fetch pour une date
  async function fetchDay(lat,lon,dateISO){
    const url=new URL('https://api.open-meteo.com/v1/meteofrance');
    url.searchParams.set('latitude',lat); url.searchParams.set('longitude',lon); url.searchParams.set('timezone','auto');
    url.searchParams.set('hourly',["temperature_2m","relative_humidity_2m","surface_pressure","wind_speed_10m","wind_gusts_10m","precipitation","visibility"].join(','));
    url.searchParams.set('start_date',dateISO); url.searchParams.set('end_date',dateISO);
    url.searchParams.set('current','temperature_2m');
    const r=await fetch(url.toString()); if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  // ===== Rendu ville+date
  async function loadCityDate(lat,lon,dateISO){
    const status=$("status"); if(status) status.textContent='Chargement‚Ä¶';
    try{
      const d=await fetchDay(lat,lon,dateISO);
      const H=d.hourly||{}; const S=computeDaySummaryFromHourly(H,dateISO);
      if(!S){ if(status) status.innerHTML='<span style="color:var(--err)">Pas de donn√©es pour cette date.</span>'; return; }
      const {rhoMean,ratioMean,scoreDay,events,Tmean,RHmean,Pmean,Wmax,Gmax,Rmax}=S;
      $("kT").textContent=fmt(Tmean," ¬∞C"); $("kRH").textContent=fmt(RHmean," %"); $("kP").textContent=fmt(Pmean," hPa");
      $("kWind").textContent=(Wmax!=null?Wmax.toFixed(0):'‚Äî')+(Gmax!=null?` ‚Ä¢ raf ${Gmax.toFixed(0)}`:'');
      $("kPrec").textContent=(Rmax!=null?Rmax.toFixed(2):'‚Äî');
      $("kRho").textContent=fmt(rhoMean," kg/m¬≥"); $("kRatio").textContent=(ratioMean?ratioMean.toFixed(3):'‚Äî'); $("kTs").textContent=dateISO;
      // Densit√© : vert -> orange -> rouge (air pauvre -> riche)
      gaugeHalfGradient('gRho', ratioMean, 0.90, 1.08, [ [0,'#10b981'], [50,'#f6b234'], [100,'#ef4444'] ]);
      // Score : rouge -> orange -> vert (d√©favorable -> favorable)
      gaugeHalfGradient('gScore', scoreDay, 0, 100, [ [0,'#ef4444'], [50,'#f6b234'], [100,'#10b981'] ]);
      $("gScoreTxt").textContent = (scoreDay>=80? 'üü¢ Favorables (journ√©e)': (scoreDay>=50? 'üü† Mitig√©es (journ√©e)':'üî¥ D√©favorables (journ√©e)'));
      $("gRhoTxt").textContent = (ratioMean==null? '‚Äî' : (ratioMean<0.99? 'Air plut√¥t l√©ger (vert)' : (ratioMean<=1.03? 'Densit√© moyenne (jaune/orange)' : 'Air riche (rouge)')));
      $("dayMsg").textContent = (events.length? ('Ph√©nom√®nes attendus : '+events.join(', ')) : 'Aucun ph√©nom√®ne notable li√© aux voyants.');
      renderLamps(S);
      if(status) status.innerHTML=`‚úÖ Donn√©es du ${dateISO} charg√©es (<span style="font-family:monospace">${(+lat).toFixed(4)}, ${(+lon).toFixed(4)}</span>)`;
    }catch(e){ console.error(e); if(status) status.innerHTML=`<span style=\"color:var(--err)\">√âchec : ${e.message}</span>`; }
  }

  // ===== Geocoding avec autocompl√©tion
  async function searchCityInto(inputId, resultsId, onPick){
    const q=($(inputId).value||'').trim(); const cont=$(resultsId); if(!cont) return; cont.innerHTML='';
    if(!q){ const holder=(resultsId==='results'? $("status"):$("statusRoute")); if(holder) holder.textContent='Saisissez une ville.'; return; }
    const holder=(resultsId==='results'? $("status"):$("statusRoute")); if(holder) holder.textContent='Recherche‚Ä¶';
    try{
      const u=new URL('https://geocoding-api.open-meteo.com/v1/search'); u.searchParams.set('name',q); u.searchParams.set('count',8); u.searchParams.set('language','fr'); u.searchParams.set('format','json');
      const r=await fetch(u.toString()); if(!r.ok) throw new Error('HTTP '+r.status);
      const d=await r.json(); const res=d.results||[]; if(res.length===0){ if(holder) holder.innerHTML='<span style="color:var(--err)">Aucun r√©sultat.</span>'; return; }
      if(holder) holder.textContent=`R√©sultats : ${res.length}`;
      for(const v of res){ const b=document.createElement('button'); b.className='cityItem'; const admin=v.admin1?`, ${v.admin1}`:''; b.innerHTML=`<span>${v.name}${admin} ‚Äî ${v.country_code}</span><span style="font-family:monospace;color:#cbd5e1">${v.latitude.toFixed(4)}, ${v.longitude.toFixed(4)}</span>`; b.onclick=()=>{ onPick(v); cont.innerHTML=''; }; cont.appendChild(b); }
    }catch(e){ console.error(e); if(holder) holder.innerHTML=`<span style=\"color:var(--err)\">Erreur recherche : ${e.message}</span>`; }
  }

  // ===== Tabs & Mode + Primary button
  let MODE='single';
  function switchMode(m){
    MODE=m;
    const s=$("panelSingle"), r=$("panelRoute"), tS=$("tabSingle"), tR=$("tabRoute"), btn=$("btnPrimary");
    if(!s||!r||!tS||!tR||!btn) return;
    if(m==='single'){
      s.style.display='block'; r.style.display='none'; tS.classList.remove('secondary'); tS.setAttribute('aria-selected','true'); tR.classList.add('secondary'); tR.setAttribute('aria-selected','false'); btn.textContent='üîÑ √âvaluer';
    } else {
      s.style.display='none'; r.style.display='block'; tR.classList.remove('secondary'); tR.setAttribute('aria-selected','true'); tS.classList.add('secondary'); tS.setAttribute('aria-selected','false'); btn.textContent='üö¶ √âvaluer l‚Äôitin√©raire';
    }
  }

  const once=(el,ev,fn)=>{ if(!el) return; el.addEventListener(ev,fn,{once:false,passive:true}); };
  once($("tabSingle"),'click',()=>switchMode('single'));
  once($("tabRoute"),'click',()=>switchMode('route'));

  function debounce(fn,ms){let t; return(...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),ms);} }
  let A=null, B=null; // villes itin√©raire

  const acSingle = debounce(()=> searchCityInto('city','results', (v)=>{ $("city").value=`${v.name}`; $("lat").value=v.latitude.toFixed(4); $("lon").value=v.longitude.toFixed(4); const st=$("status"); if(st) st.textContent=`üìç ${v.name}`; autoEvaluate(); }), 300);
  const acA = debounce(()=> searchCityInto('cityA','resultsA', (v)=>{ A={name:v.name,lat:v.latitude,lon:v.longitude}; $("cityA").value=v.name; const sr=$("statusRoute"); if(sr) sr.textContent=`D√©part : ${v.name}`; autoEvaluate(); }), 300);
  const acB = debounce(()=> searchCityInto('cityB','resultsB', (v)=>{ B={name:v.name,lat:v.latitude,lon:v.longitude}; $("cityB").value=v.name; const sr=$("statusRoute"); if(sr) sr.textContent=`Arriv√©e : ${v.name}`; autoEvaluate(); }), 300);
  once($("city"),'input', acSingle);
  once($("cityA"),'input', acA);
  once($("cityB"),'input', acB);

  // Primary sticky button
  const btnP=$("btnPrimary"); if(btnP) btnP.addEventListener('click', ()=>{
    if(MODE==='single'){
      const la=parseFloat($("lat").value), lo=parseFloat($("lon").value); const d=($("date").value||todayISO());
      const st=$("status"); if(isNaN(la)||isNaN(lo)){ if(st) st.textContent='Renseignez lat/lon ou choisissez une ville.'; return; }
      loadCityDate(la,lo,d);
    } else {
      const d=($("dateRoute").value||todayISO());
      evaluateRouteUnified(d);
    }
  }, {passive:true});

  once($("btnGeo"),'click',()=>{
    const st=$("status"); if(!navigator.geolocation){ if(st) st.textContent='G√©olocalisation non support√©e.'; return; }
    if(st) st.textContent='Localisation‚Ä¶';
    navigator.geolocation.getCurrentPosition(p=>{ const {latitude:la, longitude:lo}=p.coords; $("lat").value=la.toFixed(4); $("lon").value=lo.toFixed(4); const d=($("date").value||todayISO()); loadCityDate(la,lo,d); }, e=>{ if(st) st.textContent='G√©olocalisation refus√©e : '+e.message; }, {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
  });

  // √âvaluation itin√©raire -> alimente m√™mes jauges
  async function evaluateRouteUnified(date){
    const info=$("statusRoute"); if(!A||!B){ if(info) info.innerHTML='<span style="color:var(--err)">Choisissez d√©part et arriv√©e.</span>'; return; }
    if(info) info.textContent='Calcul itin√©raire‚Ä¶';
    try{
      const [dA,dB]=await Promise.all([fetchDay(A.lat,A.lon,date), fetchDay(B.lat,B.lon,date)]);
      const SA=computeDaySummaryFromHourly(dA.hourly||{}, date); const SB=computeDaySummaryFromHourly(dB.hourly||{}, date);
      if(!SA||!SB){ if(info) info.innerHTML='<span style="color:var(--err)">Donn√©es indisponibles pour cette date.</span>'; return; }
      const rhoAvg = avg2(SA.rhoMean, SB.rhoMean); const ratioAvg = rhoAvg? rhoAvg/1.225 : null;
      const scoreAvg = avg2(SA.scoreDay, SB.scoreDay);
      // Densit√© : vert -> orange -> rouge
      gaugeHalfGradient('gRho', ratioAvg, 0.90, 1.08, [ [0,'#10b981'], [50,'#f6b234'], [100,'#ef4444'] ]);
      // Score : rouge -> orange -> vert
      gaugeHalfGradient('gScore', scoreAvg, 0, 100, [ [0,'#ef4444'], [50,'#f6b234'], [100,'#10b981'] ]);
      $("gScoreTxt").textContent = (scoreAvg>=80? 'üü¢ Favorables (itin√©raire)': (scoreAvg>=50? 'üü† Mitig√©es (itin√©raire)':'üî¥ D√©favorables (itin√©raire)'));
      $("gRhoTxt").textContent = (ratioAvg==null? '‚Äî' : `œÅ/œÅ‚ÇÄ moyen itin√©raire: ${ratioAvg.toFixed(3)}`);
      const ev = Array.from(new Set([...(SA.events||[]), ...(SB.events||[])]));
      $("dayMsg").textContent = ev.length? `Ph√©nom√®nes possibles sur l‚Äôitin√©raire : ${ev.join(', ')}` : 'Aucun ph√©nom√®ne notable (itin√©raire).';
      renderLamps({Tmean:avg2(SA.Tmean,SB.Tmean), RHmean:avg2(SA.RHmean,SB.RHmean), Rmax:avg2(SA.Rmax,SB.Rmax), Wmax:avg2(SA.Wmax,SB.Wmax), Gmax:avg2(SA.Gmax,SB.Gmax), Vmin:avg2(SA.Vmin,SB.Vmin)});
      $("kT").textContent=fmt(avg2(SA.Tmean,SB.Tmean)," ¬∞C");
      $("kRH").textContent=fmt(avg2(SA.RHmean,SB.RHmean)," %");
      $("kP").textContent=fmt(avg2(SA.Pmean,SB.Pmean)," hPa");
      $("kWind").textContent=`${Math.round(avg2(SA.Wmax,SB.Wmax)||0)} ‚Ä¢ raf ${Math.round(avg2(SA.Gmax,SB.Gmax)||0)}`;
      $("kPrec").textContent=fmt(avg2(SA.Rmax,SB.Rmax),"");
      $("kRho").textContent=fmt(rhoAvg," kg/m¬≥"); $("kRatio").textContent=(ratioAvg?ratioAvg.toFixed(3):'‚Äî'); $("kTs").textContent=date;
      if(info) info.innerHTML=`‚úÖ Itin√©raire √©valu√© pour le ${date} ‚Äî ${A.name} ‚Üî ${B.name}`;
      switchMode('route');
    }catch(e){ console.error(e); if(info) info.innerHTML=`<span style=\"color:var(--err)\">√âchec : ${e.message}</span>`; }
  }

  // Auto-√©valuation quand date change ou quand villes/ville choisies
  const d1=$("date"), d2=$("dateRoute");
  if(d1) d1.addEventListener('change', ()=> autoEvaluate(), {passive:true});
  if(d2) d2.addEventListener('change', ()=> autoEvaluate(), {passive:true});
  function autoEvaluate(){
    if(MODE==='single'){
      const la=parseFloat($("lat").value), lo=parseFloat($("lon").value); const d=($("date").value||todayISO());
      if(!isNaN(la)&&!isNaN(lo)) loadCityDate(la,lo,d);
    } else {
      const d=($("dateRoute").value||todayISO());
      if(A&&B) evaluateRouteUnified(d);
    }
  }

  // Defaults (d√©mo Paris)
  document.addEventListener('DOMContentLoaded', ()=>{
    const d=todayISO(); const dateEl=$("date"), dateRt=$("dateRoute"); if(dateEl) dateEl.value=d; if(dateRt) dateRt.value=d;
    const la=48.8566, lo=2.3522; if($("lat")) $("lat").value=la.toFixed(4); if($("lon")) $("lon").value=lo.toFixed(4);
    const st=$("status"); if(st) st.textContent='üü¢ D√©mo : Paris (jour courant).';
    loadCityDate(la,lo,d);
  });
})();
</script>
</body>
</html>
