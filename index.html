<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RideScore</title>
  <link rel="preconnect" href="https://api.open-meteo.com"/>
  <link rel="preconnect" href="https://geocoding-api.open-meteo.com"/>
  <style>
    :root{
      /* mode nuit uniquement */
      --bg:#0b1120;
      --panel:#101826;
      --muted:#9fb0c7;
      --brand:#13b0a6;
      --ok:#10b981;
      --warn:#f6b234;
      --err:#ef4444;
      --text:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding:16px 16px 10px;
      text-align:center;
      background:#0f172a;
    }
    .header-brand{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
    }
    .header-brand h1{
      margin:0;
      font-size:1.9rem;
    }
    .header-brand p{
      margin:3px 0 0;
      color:var(--muted);
      font-size:.9rem;
    }
    .container{max-width:980px;margin:0 auto;padding:0 10px 80px}
    .card{background:var(--panel);border:1px solid #ffffff14;border-radius:14px;padding:10px;margin-top:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 4px}
    input{
      width:100%;padding:12px;border-radius:10px;border:1px solid #ffffff22;
      background:#0b1220;color:var(--text);font-size:15px
    }
    button{
      border:0;border-radius:10px;padding:12px 14px;font-weight:600;cursor:pointer;
      background:var(--brand);color:#062a2b;font-size:15px
    }
    .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1 1 160px}
    .grid{display:grid;gap:10px}.two{grid-template-columns:1fr 1fr}.three{grid-template-columns:repeat(3,1fr)}
    @media(max-width:900px){.two,.three{grid-template-columns:1fr}}
    .kpi{display:grid;grid-template-columns:1fr auto;gap:4px;padding:10px;border-radius:10px;background:#0b1220;border:1px solid #ffffff10}
    .kpi .label{color:var(--muted);font-size:12px}.kpi .value{font-size:18px;font-weight:800}
    .results{display:grid;gap:6px;margin-top:6px}
    .cityItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#0b1220;border:1px solid #ffffff14;color:#fff;cursor:pointer}
    .gaugeSVG{max-width:220px;height:auto;display:block;margin:auto}
    .guidance{text-align:center;color:#cbd5e1;font-size:12px;margin-top:6px}
    .lamps{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:6px;margin-top:8px}
    .lamp{display:flex;gap:8px;align-items:center;background:#0b1220;border:1px solid #ffffff14;border-radius:10px;padding:8px}
    .led{width:9px;height:9px;border-radius:50%;background:#334155}
    .on.green{background:#10b981}.on.yellow{background:#f6b234}.on.red{background:#ef4444}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <!-- Logo inline inspir√© de ta PJ -->
    <svg width="70" height="60" viewBox="0 0 148 124" aria-label="RideScore" role="img">
      <!-- nuage arri√®re -->
      <path d="M92 29c5-9 14-15 24-15 15 0 28 12 28 28 8 0 14 6 14 14s-6 14-14 14H92V29z" fill="#d5d8dc" stroke="#2d3b46" stroke-width="3" opacity=".7"/>
      <!-- nuage avant -->
      <path d="M20 74c0-10 8-18 18-18 3-13 15-23 30-23 17 0 31 13 31 30 10 0 18 8 18 18s-8 18-18 18H38c-10 0-18-8-18-18z" fill="#c4ccd4" stroke="#2d3b46" stroke-width="3"/>
      <!-- casque -->
      <path d="M26 68c0-20 17-37 38-37 16 0 30 10 35 24l1 4c1 4-2 8-6 10l-16 8c-5 2-10 4-16 4H44c-12 0-18-9-18-13z" fill="#fff" stroke="#2d3b46" stroke-width="3"/>
      <!-- visi√®re -->
      <path d="M47 54h33c5 0 9 4 9 9v5H42v-5c0-5 3-9 5-9z" fill="#e0e6ed" stroke="#2d3b46" stroke-width="3"/>
      <circle cx="71" cy="45" r="4" fill="#2d3b46"/>
      <!-- jauge -->
      <path d="M106 44a26 26 0 1 1-3 26" fill="none" stroke="#2d3b46" stroke-width="5" opacity=".7"/>
      <path d="M106 44a26 26 0 0 1 22 12" fill="none" stroke="#f9c934" stroke-width="7" stroke-linecap="round"/>
      <path d="M128 56a26 26 0 0 1 7 14" fill="none" stroke="#ef4444" stroke-width="7" stroke-linecap="round"/>
      <circle cx="111" cy="74" r="4" fill="#2d3b46"/>
      <line x1="111" y1="74" x2="130" y2="65" stroke="#2d3b46" stroke-width="5" stroke-linecap="round"/>
    </svg>
    <div>
      <h1 style="margin:0">RideScore</h1>
      <p style="margin:0" class="muted">Densit√© de l‚Äôair, score m√©t√©o et voyants moto</p>
    </div>
  </div>
</header>

<main class="container">
  <!-- Recherche ville -->
  <section class="card">
    <div class="row">
      <div>
        <label for="city">Rechercher une ville</label>
        <input id="city" type="text" placeholder="Ex. Paris, Lyon, Marseille‚Ä¶" autocomplete="off"/>
        <div id="results" class="results" aria-live="polite"></div>
      </div>
      <div>
        <label for="date">Date</label>
        <input id="date" type="date"/>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnSearch">üîé Chercher</button>
      <button id="btnGeo">üìç Ma position</button>
      <button id="btnLoad" style="background:#1f2937;color:#e5e7eb">üîÑ Charger</button>
    </div>
    <p id="status" class="muted" style="margin:6px 0 0"></p>
  </section>

  <!-- KPIs -->
  <section class="card">
    <div class="grid two">
      <div class="kpi"><div class="label">Temp√©rature moy. (¬∞C)</div><div class="value" id="kT">‚Äî</div></div>
      <div class="kpi"><div class="label">Humidit√© moy. (%)</div><div class="value" id="kRH">‚Äî</div></div>
      <div class="kpi"><div class="label">Pression moy. (hPa)</div><div class="value" id="kP">‚Äî</div></div>
      <div class="kpi"><div class="label">Vent/Rafales max (km/h)</div><div class="value" id="kWind">‚Äî</div></div>
      <div class="kpi"><div class="label">Pr√©cip. max (mm/h)</div><div class="value" id="kPrec">‚Äî</div></div>
      <div class="kpi"><div class="label">œÅ moy. (kg¬∑m‚Åª¬≥)</div><div class="value" id="kRho">‚Äî</div></div>
      <div class="kpi"><div class="label">œÅ/œÅ‚ÇÄ</div><div class="value" id="kRatio">‚Äî</div></div>
      <div class="kpi"><div class="label">Jour √©valu√©</div><div class="value" id="kTs" style="font-size:12px">‚Äî</div></div>
    </div>
  </section>

  <!-- Jauges + voyants -->
  <section class="card">
    <div class="grid two">
      <div>
        <p class="muted" style="margin:0 0 4px">Jauge densit√© (air pauvre ‚Üí riche)</p>
        <div id="gRho"></div>
        <div id="gRhoTxt" class="guidance">‚Äî</div>
      </div>
      <div>
        <p class="muted" style="margin:0 0 4px">Score m√©t√©o moto (0 ‚Üí 100)</p>
        <div id="gScore"></div>
        <div id="gScoreTxt" class="guidance">‚Äî</div>
      </div>
    </div>
    <div id="lamps" class="lamps"></div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 6px">Ph√©nom√®nes du jour</h2>
    <p id="dayMsg" class="muted">‚Äî</p>
  </section>
</main>

<script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id);
  const fmt=(v,u="")=>(v==null||Number.isNaN(+v))?"‚Äî":`${(+v).toFixed(2)}${u}`;
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  const polar=(cx,cy,r,aDeg)=>{const a=aDeg*Math.PI/180;return{x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)}};
  const todayISO=()=>{const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10)};

  function rhoFromTRP(T_C,RH,p_hPa){
    if([T_C,RH,p_hPa].some(v=>v==null||isNaN(v))) return null;
    const T_K=T_C+273.15;
    const es=6.112*Math.exp(17.62*T_C/(243.12+T_C));
    const e=(RH/100)*es;
    const pd=p_hPa-e;
    const R=8.314462618, Md=0.0289652, Mv=0.018016;
    return ((pd*100)*Md + (e*100)*Mv)/(R*T_K);
  }

  // scoring
  const scoreFromTemperature=T=> (T==null||isNaN(T))?12: (T>=10&&T<=25?25:((T>=5&&T<10)||(T>25&&T<=30)?15:5));
  const scoreFromRain=p=> (p==null||isNaN(p))?12:(p===0?15:(p<1?8:0));
  const scoreFromWind=(w,g)=>{const v=Math.max(w||0,g||0);return v<25?20:(v<50?10:0)};
  const scoreFromRoadRisk=(T,RH,p)=> (T!=null&&T<=0&&(p>0||(RH!=null&&RH>80)))?0:((p>0&&p<1)||(RH!=null&&RH>90)?5:10);
  const scoreFromBlackIce=(T,RH,p)=> (T==null||isNaN(T))?6: (T<=0&&(p>0||(RH!=null&&RH>=85))?0:(T<=2&&(p>0||(RH!=null&&RH>=90))?4:10));
  const scoreFromFog=(vis,RH)=> (vis==null||isNaN(vis))?((RH!=null&&RH>95)?2:5):(vis<200?0:(vis<1000?2:(vis<4000?4:5)));
  const scoreFromDensity=r=> (r==null||isNaN(r))?10: (r>=0.95&&r<=1.05?15:((r>=0.93&&r<0.95)||(r>1.05&&r<=1.07)?8:3));
  function scoreHour({T,RH,P,W,G,R,V}){
    const rho=rhoFromTRP(T,RH,P); const ratio=rho?rho/1.225:null;
    return Math.round(Math.min(100,Math.max(0,
      scoreFromTemperature(T)+scoreFromRain(R)+scoreFromWind(W,G)+scoreFromRoadRisk(T,RH,R)+scoreFromDensity(ratio)+scoreFromBlackIce(T,RH,R)+scoreFromFog(V,RH)
    )));
  }

  function gaugeHalfGradient(elId, value, vMin, vMax, stops){
    const el=$(elId); if(!el) return;
    if(value==null||isNaN(value)){el.innerHTML='<div class="guidance">‚Äî</div>';return}
    const t=(Math.min(vMax,Math.max(vMin,value))-vMin)/(vMax-vMin);
    const size=220,cx=size/2,cy=size/2,R=96,ang=-90+180*t,arc=Math.PI*R;
    const s=polar(cx,cy,R,-90),e=polar(cx,cy,R,90),tip=polar(cx,cy,R-12,ang);
    const gid=`g_${elId}`;
    const stopsSvg=stops.map(([off,col])=>`<stop offset="${off}%" stop-color="${col}"/>`).join('');
    el.innerHTML=`<svg class="gaugeSVG" viewBox="0 0 ${size} ${size}">
      <defs><linearGradient id="${gid}" x1="0%" y1="0%" x2="100%" y2="0%">${stopsSvg}</linearGradient></defs>
      <path d="M ${s.x} ${s.y} A ${R} ${R} 0 0 1 ${e.x} ${e.y}" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="12"/>
      <path d="M ${s.x} ${s.y} A ${R} ${R} 0 0 1 ${e.x} ${e.y}" fill="none" stroke="url(#${gid})" stroke-width="12"
        stroke-dasharray="${Math.max(1,arc)}" stroke-dashoffset="${(1-t)*arc}"/>
      <line x1="${cx}" y1="${cy}" x2="${tip.x}" y2="${tip.y}" stroke="#e5e7eb" stroke-width="4" stroke-linecap="round"/>
      <circle cx="${cx}" cy="${cy}" r="5" fill="#e5e7eb"/>
    </svg>`;
  }

  function avgOnIdx(arr, idxs){ if(!arr) return null; let s=0,c=0; for(const i of idxs){ const v=arr[i]; if(v!=null){s+=v;c++;}} return c? s/c : null; }
  function avg2(a,b){ if(a==null||isNaN(a)) return b; if(b==null||isNaN(b)) return a; return (a+b)/2; }

  function computeDaySummaryFromHourly(H, dateISO){
    const times=H.time||[]; const idx=[]; for(let i=0;i<times.length;i++){ if(String(times[i]).startsWith(dateISO)) idx.push(i); }
    if(idx.length===0) return null;
    let maxWind=0,maxGust=0,maxPrec=0,minTemp=Infinity,minVis=Infinity,maxRH=0;
    let rhoSum=0,rhoCount=0; let worstScore=100;
    for(const i of idx){
      const T=H.temperature_2m?.[i]; const RH=H.relative_humidity_2m?.[i]; const P=H.surface_pressure?.[i];
      const W=H.wind_speed_10m?.[i]; const G=H.wind_gusts_10m?.[i]; const R=H.precipitation?.[i]; const V=H.visibility?.[i];
      const r=rhoFromTRP(T,RH,P); if(r!=null){rhoSum+=r; rhoCount++;}
      const s=scoreHour({T,RH,P,W,G,R,V}); worstScore=Math.min(worstScore,s);
      maxWind=Math.max(maxWind,W||0); maxGust=Math.max(maxGust,G||0); maxPrec=Math.max(maxPrec,R||0);
      if(T!=null) minTemp=Math.min(minTemp,T); if(V!=null) minVis=Math.min(minVis,V); if(RH!=null) maxRH=Math.max(maxRH,RH);
    }
    const rhoMean=rhoCount?(rhoSum/rhoCount):null; const ratioMean=rhoMean?rhoMean/1.225:null;
    const events=[]; if(maxPrec>0) events.push('averses'); if(maxWind>=25||maxGust>=50) events.push('vent'); if(minTemp<=0) events.push('risque de verglas'); if((minVis<1000)||maxRH>95) events.push('brouillard'); if(maxPrec>=1) events.push('pantalon/chaussures √©tanches');
    const Tmean=avgOnIdx(H.temperature_2m,idx); const RHmean=avgOnIdx(H.relative_humidity_2m,idx); const Pmean=avgOnIdx(H.surface_pressure,idx);
    return {rhoMean,ratioMean,scoreDay:worstScore,events,Tmean,RHmean,Pmean,Wmax:maxWind,Gmax:maxGust,Rmax:maxPrec,Vmin:(minVis<Infinity?minVis:null)};
  }

  function renderLamps({Tmean,RHmean,Rmax,Wmax,Gmax,Vmin}){
    const cont=$("lamps"); if(!cont) return;
    const T=Tmean,RH=RHmean,precip=Rmax,wind=Wmax,gust=Gmax,vis=Vmin;
    const v=Math.max(wind||0,gust||0);
    const verglas=(T!=null&&T<=1)&&((precip!=null&&precip>0)||(RH!=null&&RH>=90));
    const fogDense=(vis!=null&&vis<200)||(RH!=null&&RH>98);
    const fog=fogDense||(vis!=null&&vis<1000)||(RH!=null&&RH>95);
    const gantsHiver=(T!=null && T<10);
    const vesteChaude=(T!=null && T<15);
    const lamps=[
      {label:'Gants hiver', icon:'üß§', on:gantsHiver, tone:(T<5?'red':(T<10?'yellow':'green'))},
      {label:'Gants √©t√©', icon:'üß§', on:!gantsHiver, tone:(T>30?'red':(T>25?'yellow':'green'))},
      {label:'Veste chaude', icon:'üß•', on:vesteChaude, tone:(T<8?'red':(T<15?'yellow':'green'))},
      {label:'Veste l√©g√®re', icon:'üß•', on:!vesteChaude, tone:(T>28?'red':(T>20?'yellow':'green'))},
      {label:'Pantalon pluie', icon:'üëñ', on:((precip!=null&&precip>0)||(RH!=null&&RH>80)), tone:(precip>=1?'red':'yellow')},
      {label:'Chaussures √©tanches', icon:'üë¢', on:(precip!=null&&precip>=1), tone:(precip>=2?'red':'yellow')},
      {label:'Attention vent', icon:'üí®', on:(v>=25), tone:(v>50?'red':'yellow')},
      {label:'Risque verglas', icon:'üßä', on:verglas, tone:(T!=null&&T<=0)?'red':'yellow'},
      {label:'Brouillard', icon:'üå´Ô∏è', on:fog, tone:(fogDense?'red':'yellow')},
      {label:'Visi√®re claire', icon:'üï∂Ô∏è', on:((RH!=null&&RH>95)||(precip!=null&&precip>0)), tone:'yellow'}
    ];
    cont.innerHTML=lamps.map(l=>`<div class="lamp"><span class="led ${l.on?('on '+l.tone):''}"></span><span>${l.icon} ${l.label}</span></div>`).join('');
  }

  async function fetchDay(lat,lon,dateISO){
    const url=new URL('https://api.open-meteo.com/v1/meteofrance');
    url.searchParams.set('latitude',lat);
    url.searchParams.set('longitude',lon);
    url.searchParams.set('timezone','auto');
    url.searchParams.set('hourly',[
      "temperature_2m","relative_humidity_2m","surface_pressure",
      "wind_speed_10m","wind_gusts_10m","precipitation","visibility"
    ].join(','));
    url.searchParams.set('start_date',dateISO);
    url.searchParams.set('end_date',dateISO);
    const r=await fetch(url.toString());
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  async function loadCityDate(lat,lon,dateISO){
    const status=$("status"); if(status) status.textContent='Chargement‚Ä¶';
    try{
      const d=await fetchDay(lat,lon,dateISO);
      const H=d.hourly||{};
      const S=computeDaySummaryFromHourly(H,dateISO);
      if(!S){ if(status) status.innerHTML='<span style="color:#ef4444">Pas de donn√©es pour cette date.</span>'; return; }
      const {rhoMean,ratioMean,scoreDay,events,Tmean,RHmean,Pmean,Wmax,Gmax,Rmax}=S;
      $("kT").textContent=fmt(Tmean," ¬∞C");
      $("kRH").textContent=fmt(RHmean," %");
      $("kP").textContent=fmt(Pmean," hPa");
      $("kWind").textContent=(Wmax!=null?Wmax.toFixed(0):'‚Äî')+(Gmax!=null?` ‚Ä¢ raf ${Gmax.toFixed(0)}`:'');
      $("kPrec").textContent=(Rmax!=null?Rmax.toFixed(2):'‚Äî');
      $("kRho").textContent=fmt(rhoMean," kg/m¬≥");
      $("kRatio").textContent=(ratioMean?ratioMean.toFixed(3):'‚Äî');
      $("kTs").textContent=dateISO;
      // Densit√© : vert -> orange -> rouge
      gaugeHalfGradient('gRho', ratioMean, 0.90, 1.08, [ [0,'#10b981'], [50,'#f6b234'], [100,'#ef4444'] ]);
      // Score : rouge -> orange -> vert
      gaugeHalfGradient('gScore', scoreDay, 0, 100, [ [0,'#ef4444'], [50,'#f6b234'], [100,'#10b981'] ]);
      $("gScoreTxt").textContent = (scoreDay>=80? 'üü¢ Favorables' : (scoreDay>=50? 'üü† Mitig√©es' : 'üî¥ D√©favorables'));
      $("gRhoTxt").textContent = (ratioMean==null? '‚Äî' : (ratioMean<0.99? 'Air plut√¥t l√©ger (vert)' : (ratioMean<=1.03? 'Densit√© moyenne (jaune/orange)' : 'Air riche (rouge)')));
      $("dayMsg").textContent = (events.length? 'Ph√©nom√®nes attendus : '+events.join(', ') : 'Aucun ph√©nom√®ne notable li√© aux voyants.');
      renderLamps(S);
      if(status) status.innerHTML=`‚úÖ Donn√©es du ${dateISO} charg√©es (${(+lat).toFixed(4)}, ${(+lon).toFixed(4)})`;
    }catch(e){
      console.error(e);
      if(status) status.innerHTML=`<span style="color:#ef4444">√âchec : ${e.message}</span>`;
    }
  }

  async function searchCity(){
    const q=($("city").value||'').trim();
    const cont=$("results"); cont.innerHTML='';
    if(!q){ $("status").textContent='Saisissez une ville.'; return; }
    $("status").textContent='Recherche‚Ä¶';
    try{
      const u=new URL('https://geocoding-api.open-meteo.com/v1/search');
      u.searchParams.set('name',q);
      u.searchParams.set('count',8);
      u.searchParams.set('language','fr');
      u.searchParams.set('format','json');
      const r=await fetch(u.toString());
      if(!r.ok) throw new Error('HTTP '+r.status);
      const d=await r.json(); const res=d.results||[];
      if(res.length===0){ $("status").innerHTML='<span style="color:#ef4444">Aucun r√©sultat.</span>'; return; }
      $("status").textContent=`R√©sultats : ${res.length}`;
      for(const v of res){
        const b=document.createElement('button'); b.className='cityItem';
        const admin=v.admin1?`, ${v.admin1}`:'';
        b.innerHTML=`<span>${v.name}${admin} ‚Äî ${v.country_code}</span><span style="font-family:monospace;color:#cbd5e1">${v.latitude.toFixed(4)}, ${v.longitude.toFixed(4)}</span>`;
        b.onclick=()=>{
          $("city").value=v.name;
          $("results").innerHTML='';
          const date=($("date").value||todayISO());
          loadCityDate(v.latitude,v.longitude,date);
        };
        cont.appendChild(b);
      }
    }catch(e){
      console.error(e);
      $("status").innerHTML=`<span style="color:#ef4444">Erreur recherche : ${e.message}</span>`;
    }
  }

  $("btnSearch").addEventListener('click', searchCity, {passive:true});
  $("city").addEventListener('keydown', e=>{ if(e.key==='Enter') searchCity(); }, {passive:true});
  $("btnLoad").addEventListener('click', ()=>{
    const la=parseFloat(prompt('Latitude ? (ex: 48.8566)','48.8566'));
    const lo=parseFloat(prompt('Longitude ? (ex: 2.3522)','2.3522'));
    const date=($("date").value||todayISO());
    if(isNaN(la)||isNaN(lo)){ $("status").textContent='Coordonn√©es invalides.'; return; }
    loadCityDate(la,lo,date);
  }, {passive:true});
  $("btnGeo").addEventListener('click', ()=>{
    if(!navigator.geolocation){ $("status").textContent='G√©olocalisation non support√©e.'; return; }
    $("status").textContent='Localisation‚Ä¶';
    navigator.geolocation.getCurrentPosition(p=>{
      const {latitude:la,longitude:lo}=p.coords;
      $("city").value=`üìç ${la.toFixed(4)}, ${lo.toFixed(4)}`;
      const date=($("date").value||todayISO());
      loadCityDate(la,lo,date);
    }, e=>{
      $("status").textContent='G√©olocalisation refus√©e : '+e.message;
    }, {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
  }, {passive:true});

  document.addEventListener('DOMContentLoaded', ()=>{
    const d=todayISO(); $("date").value=d;
    loadCityDate(48.8566,2.3522,d); // d√©mo Paris
  });
})();
</script>
</body>
</html>
