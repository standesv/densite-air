<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>RideScore ‚Äî m√©t√©o moto</title>
  <link rel="preconnect" href="https://api.open-meteo.com"/>
  <link rel="preconnect" href="https://geocoding-api.open-meteo.com"/>
  <style>
    :root{
      --bg:#0b1120; --panel:#101826; --muted:#9fb0c7;
      --brand:#13b0a6; --brand-ink:#062a2b;
      --ok:#10b981; --warn:#f6b234; --err:#ef4444;
      --text:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:16px;background:#0f172a}
    .header-brand{display:flex;gap:12px;align-items:center;justify-content:center}
    .header-brand img{height:64px;width:auto;display:block}
    .header-brand h1{margin:0;font-size:1.7rem}
    .header-brand p{margin:3px 0 0;color:var(--muted)}
    .container{max-width:980px;margin:0 auto;padding:0 10px 90px}
    .card{background:var(--panel);border:1px solid #ffffff14;border-radius:14px;padding:10px;margin-top:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #ffffff22;background:#0b1220;color:var(--text)}
    button{border:0;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer;background:var(--brand);color:var(--brand-ink)}
    .row{display:flex;gap:8px;flex-wrap:wrap}.row>*{flex:1 1 160px}
    .grid{display:grid;gap:10px}.three{grid-template-columns:repeat(3,1fr)}
    @media(max-width:900px){.three{grid-template-columns:1fr}}
    .tabs{display:flex;gap:8px}.tabs button{flex:1}
    .results{display:grid;gap:6px;margin-top:6px}
    .cityItem{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#0b1220;border:1px solid #ffffff14;color:#fff;cursor:pointer}
    .lamps{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:6px}
    .lamp{display:flex;gap:8px;align-items:center;background:#0b1220;border:1px solid #ffffff14;border-radius:10px;padding:8px}
    .led{width:9px;height:9px;border-radius:50%;background:#334155}
    .on.green{background:#10b981}.on.yellow{background:#f6b234}.on.red{background:#ef4444}
    .muted{color:var(--muted)}
    .stickyBar{position:fixed;left:0;right:0;bottom:0;z-index:10;display:flex;gap:8px;padding:10px;background:var(--bg);border-top:1px solid #ffffff14}
    .stickyBar button{flex:1}
    .modepill{display:inline-flex;background:#0b1220;border:1px solid #ffffff1f;border-radius:999px;overflow:hidden;margin-top:6px}
    .modepill button{background:transparent;border:0;padding:6px 12px;font-size:12px;color:#cbd5e1;cursor:pointer}
    .modepill button.active{background:#13b0a6;color:#062a2b;font-weight:600}
    /* Jauges */
    .gaugesRow{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;justify-content:center}
    .gBox{flex:0 1 135px;min-width:130px;text-align:left}
    .gBox p{margin:0 0 4px}
    .gaugeSVG{width:120px;max-width:100%;height:auto;display:block}
    .guidance{color:#cbd5e1;font-size:12px;margin-top:4px}
    @media(max-width:360px){
      .gBox{flex:1 1 100%;display:flex;flex-direction:column;align-items:center;text-align:center}
      .gBox p{text-align:center}
      .gaugeSVG{margin:0 auto;}
    }
    /* D√©tails en petits cadres */
    .kpiGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:6px}
    .kpiCard{background:#0b1220;border:1px solid #ffffff10;border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;gap:4px;min-height:60px}
    .kpiLabel{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
    .kpiValue{font-size:1.15rem;font-weight:700}
    .kpiSmall{font-size:10px;color:#6b7280}
    .hide{display:none!important}
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <img src="ridescore-logo.png" alt="RideScore, m√©t√©o moto">
    <div>
      <h1>RideScore</h1>
      <p>La m√©t√©o pens√©e pour les motards</p>
    </div>
  </div>
</header>

<main class="container">
  <!-- S√©lection -->
  <section class="card">
    <h2 style="margin:0 0 6px">Ville ou itin√©raire</h2>
    <div class="tabs">
      <button id="tabSingle" aria-selected="true">Ville</button>
      <button id="tabRoute" aria-selected="false" style="background:#1f2937;color:#e5e7eb">Itin√©raire</button>
    </div>

    <!-- Mode ville -->
    <div id="panelSingle" style="margin-top:8px">
      <div class="modepill" id="modePill">
        <button type="button" data-mode="day" class="active">Jour (moy.)</button>
        <button type="button" data-mode="now">Temps r√©el</button>
      </div>
      <div class="grid three" style="margin-top:6px">
        <div>
          <label for="city">Ville</label>
          <input id="city" placeholder="Ex. Paris‚Ä¶" autocomplete="off"/>
          <div id="results" class="results"></div>
        </div>
        <div>
          <label for="date">Date</label>
          <input id="date" type="date"/>
        </div>
      </div>
      <details>
        <summary>Options avanc√©es</summary>
        <div class="row" style="margin-top:6px">
          <div><label for="lat">Latitude</label><input id="lat" type="number" step="0.0001" placeholder="48.8566"/></div>
          <div><label for="lon">Longitude</label><input id="lon" type="number" step="0.0001" placeholder="2.3522"/></div>
        </div>
      </details>
      <p id="status" class="muted" style="margin:6px 0 0;"></p>
    </div>

    <!-- Mode itin√©raire -->
    <div id="panelRoute" style="margin-top:8px;display:none">
      <div class="grid three">
        <div>
          <label for="cityA">Ville d√©part</label>
          <input id="cityA" autocomplete="off"/>
          <div id="resultsA" class="results"></div>
        </div>
        <div>
          <label for="cityB">Ville arriv√©e</label>
          <input id="cityB" autocomplete="off"/>
          <div id="resultsB" class="results"></div>
        </div>
        <div>
          <label for="dateRoute">Date</label>
          <input id="dateRoute" type="date"/>
        </div>
      </div>
      <p id="statusRoute" class="muted" style="margin:6px 0 0;"></p>
    </div>
  </section>

  <!-- Voyants + jauges -->
  <section class="card">
    <div id="lamps" class="lamps"></div>
    <div class="gaugesRow">
      <div class="gBox">
        <p class="muted">Score m√©t√©o</p>
        <div id="gScore"></div>
        <div id="gScoreTxt" class="guidance">‚Äî</div>
      </div>
      <div class="gBox">
        <p class="muted">Densit√© de l‚Äôair</p>
        <div id="gRho"></div>
        <div id="gRhoTxt" class="guidance">‚Äî</div>
      </div>
    </div>
  </section>

  <!-- Ph√©nom√®nes -->
  <section class="card">
    <h2 style="margin:0 0 6px">Ph√©nom√®nes du jour</h2>
    <p id="dayMsg" class="muted">‚Äî</p>
  </section>

  <!-- D√©tails -->
  <section class="card">
    <h2 style="margin:0 0 6px">D√©tails</h2>
    <div class="kpiGrid">
      <div class="kpiCard"><div class="kpiLabel">Temp√©rature</div><div class="kpiValue" id="kT">‚Äî</div></div>
      <div class="kpiCard"><div class="kpiLabel">Humidit√©</div><div class="kpiValue" id="kRH">‚Äî</div></div>
      <div class="kpiCard"><div class="kpiLabel">Vent / Rafales</div><div class="kpiValue" id="kWind">‚Äî</div></div>
      <div class="kpiCard"><div class="kpiLabel">Pr√©cipitation</div><div class="kpiValue" id="kPrec">‚Äî</div></div>
      <div class="kpiCard hide"><div class="kpiLabel">Pression</div><div class="kpiValue" id="kP">‚Äî</div></div>
      <div class="kpiCard hide"><div class="kpiLabel">œÅ (kg/m¬≥)</div><div class="kpiValue" id="kRho">‚Äî</div></div>
      <div class="kpiCard hide"><div class="kpiLabel">œÅ/œÅ‚ÇÄ</div><div class="kpiValue" id="kRatio">‚Äî</div></div>
      <div class="kpiCard hide"><div class="kpiLabel">Source</div><div class="kpiValue kpiSmall" id="kTs">‚Äî</div></div>
    </div>
  </section>
</main>

<div class="stickyBar">
  <button id="btnGeo">üìç Ma position</button>
  <button id="btnPrimary">üîÑ √âvaluer</button>
</div>

<script>
(function(){
  'use strict';
  const $=id=>document.getElementById(id);
  const fmt=(v,u="")=>(v==null||Number.isNaN(+v))?"‚Äî":`${(+v).toFixed(2)}${u}`;
  const todayISO=()=>{const d=new Date();d.setMinutes(d.getMinutes()-d.getTimezoneOffset());return d.toISOString().slice(0,10)};
  const isToday=iso=>iso===todayISO();
  const polar=(cx,cy,r,aDeg)=>{const a=aDeg*Math.PI/180;return{x:cx+r*Math.cos(a),y:cy+r*Math.sin(a)}};
  function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

  // densit√© d‚Äôair humide
  function rhoFromTRP(T_C,RH,p_hPa){
    if([T_C,RH,p_hPa].some(v=>v==null||isNaN(v))) return null;
    const T_K=T_C+273.15;
    const es=6.112*Math.exp(17.62*T_C/(243.12+T_C));
    const e=(RH/100)*es;
    const pd=p_hPa-e;
    const R=8.314462618, Md=0.0289652, Mv=0.018016;
    return ((pd*100)*Md+(e*100)*Mv)/(R*T_K);
  }

  // jauge demi-cercle
  function gaugeHalfGradient(elId, value, vMin, vMax, stops){
    const el=$(elId); if(!el) return;
    if(value==null||isNaN(value)){el.innerHTML='‚Äî';return}
    const t=(Math.min(vMax,Math.max(vMin,value))-vMin)/(vMax-vMin);
    const size=160,cx=size/2,cy=size/2,R=70,arc=Math.PI*R;
    const start=polar(cx,cy,R,-90),end=polar(cx,cy,R,90);
    const angle=-90+180*t, tip=polar(cx,cy,R-10,angle);
    const gid=`g_${elId}`;
    const stopsSvg=stops.map(([off,col])=>`<stop offset="${off}%" stop-color="${col}"/>`).join('');
    const visibleLen=Math.max(0.5,t*arc);
    el.innerHTML=`<svg class="gaugeSVG" viewBox="0 0 ${size} ${size}">
      <defs>
        <linearGradient id="${gid}" gradientUnits="userSpaceOnUse" x1="${start.x}" y1="${start.y}" x2="${end.x}" y2="${end.y}">
          ${stopsSvg}
        </linearGradient>
      </defs>
      <path d="M ${start.x} ${start.y} A ${R} ${R} 0 0 1 ${end.x} ${end.y}" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
      <path d="M ${start.x} ${start.y} A ${R} ${R} 0 0 1 ${end.x} ${end.y}" fill="none" stroke="url(#${gid})" stroke-width="10"
        stroke-dasharray="${visibleLen} ${arc-visibleLen}"/>
      <line x1="${cx}" y1="${cy}" x2="${tip.x}" y2="${tip.y}" stroke="#e5e7eb" stroke-width="3.5" stroke-linecap="round"/>
      <circle cx="${cx}" cy="${cy}" r="4" fill="#e5e7eb"/>
    </svg>`;
  }

  // scoring (comme avant)
  const scoreFromTemperature=T=> (T==null||isNaN(T))?12: (T>=10&&T<=25?25:((T>=5&&T<10)||(T>25&&T<=30)?15:5));
  const scoreFromRain=p=> (p==null||isNaN(p))?12:(p===0?15:(p<1?8:0));
  const scoreFromWind=(w,g)=>{const v=Math.max(w||0,g||0);return v<25?20:(v<50?10:0)};
  const scoreFromRoadRisk=(T,RH,p)=> (T!=null&&T<=0&&(p>0||(RH!=null&&RH>80)))?0:((p>0&&p<1)||(RH!=null&&RH>90)?5:10);
  const scoreFromBlackIce=(T,RH,p)=> (T==null||isNaN(T))?6: (T<=0&&(p>0||(RH!=null&&RH>=85))?0:(T<=2&&(p>0||(RH!=null&&RH>=90))?4:10));
  const scoreFromFog=(vis,RH)=> (vis==null||isNaN(vis))?((RH!=null&&RH>95)?2:5):(vis<200?0:(vis<1000?2:(vis<4000?4:5)));
  const scoreFromDensity=r=> (r==null||isNaN(r))?10: (r>=0.95&&r<=1.05?15:((r>=0.93&&r<0.95)||(r>1.05&&r<=1.07)?8:3));
  function scoreHour({T,RH,P,W,G,R,V}){
    const rho=rhoFromTRP(T,RH,P); const ratio=rho?rho/1.225:null;
    return Math.round(Math.min(100,Math.max(0,
      scoreFromTemperature(T)+scoreFromRain(R)+scoreFromWind(W,G)+scoreFromRoadRisk(T,RH,R)+scoreFromDensity(ratio)+scoreFromBlackIce(T,RH,R)+scoreFromFog(V,RH)
    )));
  }

  function avgOnIdx(arr, idxs){ if(!arr) return null; let s=0,c=0; for(const i of idxs){ const v=arr[i]; if(v!=null){s+=v;c++;}} return c? s/c : null; }
  function avg2(a,b){ if(a==null||isNaN(a)) return b; if(b==null||isNaN(b)) return a; return (a+b)/2; }

  function computeDaySummaryFromHourly(H, dateISO){
    const times=H.time||[]; const idx=[];
    for(let i=0;i<times.length;i++){ if(String(times[i]).startsWith(dateISO)) idx.push(i); }
    if(idx.length===0) return null;
    let maxWind=0,maxGust=0,maxPrec=0,minTemp=Infinity,minVis=Infinity,maxRH=0;
    let rhoSum=0,rhoCount=0; let worstScore=100;
    for(const i of idx){
      const T=H.temperature_2m?.[i];
      const RH=H.relative_humidity_2m?.[i];
      const P=H.surface_pressure?.[i];
      const W=H.wind_speed_10m?.[i];
      const G=H.wind_gusts_10m?.[i];
      const R=H.precipitation?.[i];
      const V=H.visibility?.[i];
      const r=rhoFromTRP(T,RH,P); if(r!=null){rhoSum+=r; rhoCount++;}
      const s=scoreHour({T,RH,P,W,G,R,V}); worstScore=Math.min(worstScore,s);
      maxWind=Math.max(maxWind,W||0); maxGust=Math.max(maxGust,G||0); maxPrec=Math.max(maxPrec,R||0);
      if(T!=null) minTemp=Math.min(minTemp,T);
      if(V!=null) minVis=Math.min(minVis,V);
      if(RH!=null) maxRH=Math.max(maxRH,RH);
    }
    const rhoMean=rhoCount?(rhoSum/rhoCount):null;
    const ratioMean=rhoMean?rhoMean/1.225:null;
    const events=[];
    if (maxPrec > 0) events.push('averses');
    if (maxWind >= 25 || maxGust >= 50) events.push('vent');
    if (minTemp <= 0) events.push('risque de verglas');
    if ((minVis < 1000) || maxRH > 95) events.push('brouillard');
    const Tmean=avgOnIdx(H.temperature_2m,idx);
    const RHmean=avgOnIdx(H.relative_humidity_2m,idx);
    const Pmean=avgOnIdx(H.surface_pressure,idx);
    return {rhoMean,ratioMean,scoreDay:worstScore,events,Tmean,RHmean,Pmean,Wmax:maxWind,Gmax:maxGust,Rmax:maxPrec,Vmin:(minVis<Infinity?minVis:null)};
  }

  async function fetchCurrent(lat,lon){
    const url=new URL('https://api.open-meteo.com/v1/meteofrance');
    url.searchParams.set('latitude',lat);
    url.searchParams.set('longitude',lon);
    url.searchParams.set('timezone','auto');
    url.searchParams.set('current',[
      "temperature_2m","relative_humidity_2m","surface_pressure",
      "wind_speed_10m","wind_gusts_10m","precipitation","visibility"
    ].join(','));
    const r=await fetch(url.toString());
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }
  function computeCurrentSummary(cur){
    if(!cur) return null;
    const T=cur.temperature_2m, RH=cur.relative_humidity_2m, P=cur.surface_pressure;
    const W=cur.wind_speed_10m, G=cur.wind_gusts_10m, R=cur.precipitation, V=cur.visibility;
    const rho=rhoFromTRP(T,RH,P); const ratio=rho?rho/1.225:null;
    const score=scoreHour({T,RH,P,W,G,R,V});
    const events=[];
    if(R>0) events.push('averses');
    if(W>=25 || G>=50) events.push('vent');
    if(T<=0) events.push('risque de verglas');
    if((V!=null && V<1000) || (RH!=null && RH>95)) events.push('brouillard');
    return {rhoMean:rho,ratioMean:ratio,scoreDay:score,events,Tmean:T,RHmean:RH,Pmean:P,Wmax:W,Gmax:G,Rmax:R,Vmin:V,ts:cur.time};
  }

  function renderLamps({Tmean,RHmean,Rmax,Wmax,Gmax,Vmin}){
    const cont=$("lamps"); if(!cont) return;
    const T=Tmean,RH=RHmean,precip=Rmax,wind=Wmax,gust=Gmax,vis=Vmin;
    const v=Math.max(wind||0,gust||0);
    const verglas=(T!=null&&T<=1)&&((precip!=null&&precip>0)||(RH!=null&&RH>=90));
    const fogDense=(vis!=null&&vis<200)||(RH!=null&&RH>98);
    const fog=fogDense||(vis!=null&&vis<1000)||(RH!=null&&RH>95);
    const gantsHiver=(T!=null && T<10);
    const vesteChaude=(T!=null && T<15);
    const lamps=[
      {label:'Gants hiver', icon:'üß§', on:gantsHiver, tone:(T<5?'red':(T<10?'yellow':'green'))},
      {label:'Gants √©t√©', icon:'üß§', on:!gantsHiver, tone:(T>30?'red':(T>25?'yellow':'green'))},
      {label:'Veste chaude', icon:'üß•', on:vesteChaude, tone:(T<8?'red':(T<15?'yellow':'green'))},
      {label:'Veste l√©g√®re', icon:'üß•', on:!vesteChaude, tone:(T>28?'red':(T>20?'yellow':'green'))},
      {label:'Pantalon pluie', icon:'üëñ', on:((precip!=null&&precip>0)||(RH!=null&&RH>80)), tone:(precip>=1?'red':'yellow')},
      {label:'Chaussures √©tanches', icon:'üë¢', on:(precip!=null&&precip>=1), tone:(precip>=2?'red':'yellow')},
      {label:'Attention vent', icon:'üí®', on:(v>=25), tone:(v>50?'red':'yellow')},
      {label:'Risque verglas', icon:'üßä', on:verglas, tone:(T!=null&&T<=0)?'red':'yellow'},
      {label:'Brouillard', icon:'üå´Ô∏è', on:fog, tone:(fogDense?'red':'yellow')},
      {label:'Visi√®re claire', icon:'üï∂Ô∏è', on:((RH!=null&&RH>95)||(precip!=null&&precip>0)), tone:'yellow'}
    ];
    cont.innerHTML=lamps.map(l=>`<div class="lamp"><span class="led ${l.on?('on '+l.tone):''}"></span><span>${l.icon} ${l.label}</span></div>`).join('');
  }

  async function fetchDay(lat,lon,dateISO){
    const url=new URL('https://api.open-meteo.com/v1/meteofrance');
    url.searchParams.set('latitude',lat);
    url.searchParams.set('longitude',lon);
    url.searchParams.set('timezone','auto');
    url.searchParams.set('hourly',[
      "temperature_2m","relative_humidity_2m","surface_pressure",
      "wind_speed_10m","wind_gusts_10m","precipitation","visibility"
    ].join(','));
    url.searchParams.set('start_date',dateISO);
    url.searchParams.set('end_date',dateISO);
    const r=await fetch(url.toString());
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  let currentSingleMode='day';
  function setSingleModePill(mode){
    currentSingleMode=mode;
    const pill=$("modePill");
    pill.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
  }

  function updateDetailsUI({Tmean,RHmean,Pmean,Wmax,Gmax,Rmax,rhoMean,ratioMean}, label){
    $("kT").textContent=fmt(Tmean," ¬∞C");
    $("kRH").textContent=fmt(RHmean," %");
    $("kWind").textContent=(Wmax!=null?`${Wmax.toFixed(0)} km/h`:'‚Äî')+(Gmax!=null?` ‚Ä¢ raf ${Gmax.toFixed(0)} km/h`:'');
    $("kPrec").textContent=(Rmax!=null?`${Rmax.toFixed(2)} mm`:'‚Äî');
    $("kP").textContent=fmt(Pmean," hPa");
    $("kRho").textContent=fmt(rhoMean," kg/m¬≥");
    $("kRatio").textContent=(ratioMean?ratioMean.toFixed(3):'‚Äî');
    $("kTs").textContent=label||'‚Äî';
  }

  async function loadCity(lat,lon,dateISO,mode){
    const st=$("status"); if(st) st.textContent='Chargement‚Ä¶';
    try{
      const effectiveMode=(mode==='now' && !isToday(dateISO)) ? 'day' : mode;
      let S, label;
      if(effectiveMode==='now'){
        const d=await fetchCurrent(lat,lon);
        S=computeCurrentSummary(d.current);
        label='Temps r√©el';
      }else{
        const d=await fetchDay(lat,lon,dateISO);
        S=computeDaySummaryFromHourly(d.hourly||{},dateISO);
        label=dateISO;
      }
      if(!S){ st.innerHTML='<span style="color:#ef4444">Pas de donn√©es.</span>'; return; }

      updateDetailsUI({
        Tmean:S.Tmean,
        RHmean:S.RHmean,
        Pmean:S.Pmean,
        Wmax:S.Wmax,
        Gmax:S.Gmax,
        Rmax:S.Rmax,
        rhoMean:S.rhoMean,
        ratioMean:S.ratioMean
      }, label);

      // jauge score
      gaugeHalfGradient('gScore', S.scoreDay, 0, 100, [
        [0,  '#ef4444'],
        [25, '#f97316'],
        [50, '#facc15'],
        [75, '#22c55e'],
        [100,'#22c55e']
      ]);
      const needsRain = (S.Rmax!=null && S.Rmax>0) || (S.RHmean!=null && S.RHmean>90);
      let scoreLabel;
      if(S.scoreDay>=80 && !needsRain) scoreLabel='üü¢ Favorables';
      else if(S.scoreDay>=80 && needsRain) scoreLabel='üü† Mitig√©es (pluie possible)';
      else if(S.scoreDay>=50) scoreLabel='üü† Mitig√©es';
      else scoreLabel='üî¥ D√©favorable';
      $("gScoreTxt").textContent=scoreLabel;

      // jauge densit√©
      gaugeHalfGradient('gRho', S.ratioMean, 0.90, 1.08, [
        [0,  '#22c55e'],
        [25, '#facc15'],
        [50, '#f97316'],
        [75, '#ef4444'],
        [100,'#ef4444']
      ]);
      let rhoLabel='‚Äî';
      if(S.ratioMean!=null){
        if(S.ratioMean<0.99) rhoLabel='üü¢ Air plut√¥t l√©ger';
        else if(S.ratioMean<=1.03) rhoLabel='üü† Densit√© moyenne';
        else rhoLabel='üî¥ Air riche';
      }
      $("gRhoTxt").textContent=rhoLabel;

      // ph√©nom√®nes
      if(S.events && S.events.length){
        $("dayMsg").textContent = (effectiveMode==='now'
          ? 'Ph√©nom√®nes actuels : '+S.events.join(', ')
          : 'Ph√©nom√®nes attendus : '+S.events.join(', ')
        );
      }else{
        $("dayMsg").textContent = (effectiveMode==='now' ? 'Conditions actuelles calmes.' : 'Aucun ph√©nom√®ne notable.');
      }

      // voyants
      renderLamps(S);

      st.innerHTML=`‚úÖ Donn√©es charg√©es pour ${effectiveMode==='now'?'maintenant':dateISO} (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
      if(mode==='now' && effectiveMode==='day'){ setSingleModePill('day'); }
    }catch(e){
      console.error(e);
      if(st) st.innerHTML=`<span style="color:#ef4444">√âchec : ${e.message}</span>`;
    }
  }

  // recherche auto
  async function searchCityInto(inputId, resultsId, onPick){
    const q=($(inputId).value||'').trim();
    const cont=$(resultsId); cont.innerHTML='';
    const statusTarget = (resultsId==='results') ? $("status") : $("statusRoute");
    if(!q){ if(statusTarget) statusTarget.textContent='Saisissez une ville.'; return; }
    if(statusTarget) statusTarget.textContent='Recherche‚Ä¶';
    try{
      const u=new URL('https://geocoding-api.open-meteo.com/v1/search');
      u.searchParams.set('name',q); u.searchParams.set('count',8); u.searchParams.set('language','fr'); u.searchParams.set('format','json');
      const r=await fetch(u.toString()); if(!r.ok) throw new Error('HTTP '+r.status);
      const d=await r.json(); const res=d.results||[];
      if(res.length===0){ if(statusTarget) statusTarget.innerHTML='<span style="color:#ef4444">Aucun r√©sultat.</span>'; return; }
      if(statusTarget) statusTarget.textContent=`R√©sultats : ${res.length}`;
      for(const v of res){
        const b=document.createElement('button'); b.className='cityItem';
        const admin=v.admin1?`, ${v.admin1}`:'';
        b.innerHTML=`<span>${v.name}${admin} ‚Äî ${v.country_code}</span>
                     <span style="font-family:monospace;color:#cbd5e1">${v.latitude.toFixed(4)}, ${v.longitude.toFixed(4)}</span>`;
        b.onclick=()=>{ onPick(v); cont.innerHTML=''; };
        cont.appendChild(b);
      }
    }catch(e){
      console.error(e);
      if(statusTarget) statusTarget.innerHTML=`<span style="color:#ef4444">Erreur recherche : ${e.message}</span>`;
    }
  }

  // auto-complete ville (single)
  $("city").addEventListener('input', debounce(()=>{
    searchCityInto('city','results', v=>{
      $("city").value=v.name;
      $("lat").value=v.latitude.toFixed(4);
      $("lon").value=v.longitude.toFixed(4);
      const d=$("date").value || todayISO();
      loadCity(v.latitude,v.longitude,d,currentSingleMode);
    });
  }, 300));

  let A=null, B=null;

  $("cityA").addEventListener('input', debounce(()=>{
    searchCityInto('cityA','resultsA', v=>{
      A={name:v.name,lat:v.latitude,lon:v.longitude};
      $("cityA").value=v.name;
      autoEvaluate();
    });
  },300));

  $("cityB").addEventListener('input', debounce(()=>{
    searchCityInto('cityB','resultsB', v=>{
      B={name:v.name,lat:v.latitude,lon:v.longitude};
      $("cityB").value=v.name;
      autoEvaluate();
    });
  },300));

  let MODE='single';
  $("tabSingle").addEventListener('click', ()=>{
    MODE='single';
    $("panelSingle").style.display='block';
    $("panelRoute").style.display='none';
    $("tabSingle").style.background='var(--brand)'; $("tabSingle").style.color='var(--brand-ink)';
    $("tabRoute").style.background='#1f2937'; $("tabRoute").style.color='#e5e7eb';
  });
  $("tabRoute").addEventListener('click', ()=>{
    MODE='route';
    $("panelRoute").style.display='block';
    $("panelSingle").style.display='none';
    $("tabRoute").style.background='var(--brand)'; $("tabRoute").style.color='var(--brand-ink)';
    $("tabSingle").style.background=''; $("tabSingle").style.color='';
  });

  async function evaluateRoute(date){
    const info=$("statusRoute");
    if(!A||!B){ if(info) info.innerHTML='<span style="color:#ef4444">Choisissez d√©part et arriv√©e.</span>'; return; }
    if(info) info.textContent='Calcul itin√©raire‚Ä¶';
    try{
      const [dA,dB]=await Promise.all([fetchDay(A.lat,A.lon,date), fetchDay(B.lat,B.lon,date)]);
      const SA=computeDaySummaryFromHourly(dA.hourly||{},date), SB=computeDaySummaryFromHourly(dB.hourly||{},date);
      if(!SA||!SB){ if(info) info.innerHTML='<span style="color:#ef4444">Donn√©es indisponibles.</span>'; return; }
      const rhoAvg=avg2(SA.rhoMean,SB.rhoMean);
      const ratioAvg=rhoAvg?rhoAvg/1.225:null;
      const scoreAvg=avg2(SA.scoreDay,SB.scoreDay);

      // jauges
      gaugeHalfGradient('gScore', scoreAvg, 0, 100, [
        [0,  '#ef4444'],
        [25, '#f97316'],
        [50, '#facc15'],
        [75, '#22c55e'],
        [100,'#22c55e']
      ]);
      $("gScoreTxt").textContent = (scoreAvg>=80? 'üü¢ Favorables (itin√©raire)' : (scoreAvg>=50? 'üü† Mitig√©es (itin√©raire)' : 'üî¥ D√©favorable (itin√©raire)'));

      gaugeHalfGradient('gRho', ratioAvg, 0.90, 1.08, [
        [0,  '#22c55e'],
        [25, '#facc15'],
        [50, '#f97316'],
        [75, '#ef4444'],
        [100,'#ef4444']
      ]);
      let rhoLabel='‚Äî';
      if(ratioAvg!=null){
        if(ratioAvg<0.99) rhoLabel='üü¢ Air plut√¥t l√©ger';
        else if(ratioAvg<=1.03) rhoLabel='üü† Densit√© moyenne';
        else rhoLabel='üî¥ Air riche';
      }
      $("gRhoTxt").textContent=rhoLabel;

      // ph√©nom√®nes
      const ev = Array.from(new Set([...(SA.events||[]), ...(SB.events||[])]));
      $("dayMsg").textContent = ev.length ? `Ph√©nom√®nes sur l‚Äôitin√©raire : ${ev.join(', ')}` : 'Aucun ph√©nom√®ne notable (itin√©raire).';

      // voyants
      renderLamps({
        Tmean:avg2(SA.Tmean,SB.Tmean),
        RHmean:avg2(SA.RHmean,SB.RHmean),
        Rmax:avg2(SA.Rmax,SB.Rmax),
        Wmax:avg2(SA.Wmax,SB.Wmax),
        Gmax:avg2(SA.Gmax,SB.Gmax),
        Vmin:avg2(SA.Vmin,SB.Vmin)
      });

      // d√©tails avec unit√©s
      const avgWind = Math.round(avg2(SA.Wmax,SB.Wmax) || 0);
      const avgGust = Math.round(avg2(SA.Gmax,SB.Gmax) || 0);
      const avgPrec = avg2(SA.Rmax,SB.Rmax);
      $("kT").textContent=fmt(avg2(SA.Tmean,SB.Tmean)," ¬∞C");
      $("kRH").textContent=fmt(avg2(SA.RHmean,SB.RHmean)," %");
      $("kWind").textContent=`${avgWind} km/h ‚Ä¢ raf ${avgGust} km/h`;
      $("kPrec").textContent=(avgPrec!=null ? `${avgPrec.toFixed(2)} mm` : '‚Äî');
      $("kTs").textContent = date;

      if(info) info.innerHTML=`‚úÖ Itin√©raire √©valu√© pour le ${date} ‚Äî ${A.name} ‚Üî ${B.name}`;
    }catch(e){
      console.error(e);
      if(info) info.innerHTML=`<span style="color:#ef4444">√âchec : ${e.message}</span>`;
    }
  }

  function autoEvaluate(){
    if(MODE==='single'){
      const la=parseFloat($("lat").value), lo=parseFloat($("lon").value);
      const d=$("date").value || todayISO();
      if(!isNaN(la)&&!isNaN(lo)) loadCity(la,lo,d,currentSingleMode);
    }else{
      const d=$("dateRoute").value || todayISO();
      if(A&&B) evaluateRoute(d);
    }
  }

  $("modePill").addEventListener('click', e=>{
    if(e.target && e.target.dataset && e.target.dataset.mode){
      setSingleModePill(e.target.dataset.mode);
      autoEvaluate();
    }
  });

  $("date").addEventListener('change', autoEvaluate);
  $("dateRoute").addEventListener('change', autoEvaluate);

  $("btnPrimary").addEventListener('click', ()=>{
    if(MODE==='single'){
      const la=parseFloat($("lat").value), lo=parseFloat($("lon").value);
      const d=$("date").value || todayISO();
      if(isNaN(la)||isNaN(lo)){ $("status").textContent='Renseignez lat/lon ou choisissez une ville.'; return; }
      loadCity(la,lo,d,currentSingleMode);
    }else{
      const d=$("dateRoute").value || todayISO();
      evaluateRoute(d);
    }
  });

  $("btnGeo").addEventListener('click', ()=>{
    const st=$("status");
    if(!navigator.geolocation){ st.textContent='G√©olocalisation non support√©e.'; return; }
    st.textContent='Localisation‚Ä¶';
    navigator.geolocation.getCurrentPosition(p=>{
      const {latitude:la,longitude:lo}=p.coords;
      $("lat").value=la.toFixed(4); $("lon").value=lo.toFixed(4);
      const d=$("date").value || todayISO();
      loadCity(la,lo,d,currentSingleMode);
    }, e=>{
      st.textContent='G√©olocalisation refus√©e : '+e.message;
    }, {enableHighAccuracy:true,timeout:10000,maximumAge:60000});
  });

  // d√©mo par d√©faut
  document.addEventListener('DOMContentLoaded',()=>{
    const d=todayISO();
    $("date").value=d;
    $("dateRoute").value=d;
    const la=48.8566, lo=2.3522;
    $("lat").value=la.toFixed(4);
    $("lon").value=lo.toFixed(4);
    $("status").textContent='üü¢ D√©mo : Paris charg√© (moyenne journ√©e).';
    loadCity(la,lo,d,'day');
  });
})();
</script>
</body>
</html>
